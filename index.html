<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="https://quantumv2.github.io/FileArt/favicon.png" />
    <meta property="og:image" content="https://quantumv2.github.io/FileArt/favicon.png" />
    <meta property="og:title" content="FileArt">
    <meta property="og:description" content="Displays files as an image!">
    <title>File Art</title>
</head>
<body>
    <input type="file" id="upload-btn" style="width: 0" /> <!--width 0 hides the no file selected thingy-->
    <button onclick="download()">Download Image</button>
    <div class="container centered-div">
        <canvas id="canvas"></canvas>
    </div>

    <style>
        body {
            background-color: #1c1c1c;
            font-family: 'Courier New', monospace;
        }


        .centered-div{
            z-index: 1;
            position: absolute;
            top: 5%;
            left: 50%;
            transform: translate(-50%, -5%);
        }


        input[type="file"]::-webkit-file-upload-button {
            z-index: 2;
            position: absolute;
            bottom: 15vh;
            left: 50vw;
            transform: translate(-50%, -15vh);
            background-color: #151616;
            border: none;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: medium;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 50px;
        }
        button {
            z-index: 3;
            position: absolute;
            bottom: 10vh;
            left: 50vw;
            transform: translate(-50%, -10vh);
            background-color: #151616;
            border: none;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: medium;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 50px;
        }
        
    </style>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        let cvWidth = parseInt(urlParams.get('width'));
        let skip = parseInt(urlParams.get('skip')) || 0;
        let pushLimit = parseInt(urlParams.get('push')) || skip + 1;
        // function to convert file to hex
        const fileToHex = (file) => new Promise((resolve, reject) => {
            const chunkSize = 1024 * 1024; // Read 1 MB at a time
            const hexParts = [];

            const readChunk = (offset) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    const arrayBuffer = reader.result;
                    const byteArray = new Uint8Array(arrayBuffer);

                
                    for (let i = skip; i < byteArray.length; i += pushLimit) {
                        const hex = byteArray[i].toString(16);
                        const paddedHex = ('00' + hex).slice(-2);
                        hexParts.push(paddedHex);
                    }

                    if (offset + chunkSize < file.size) {
                        readChunk(offset + chunkSize);
                    } else {
                        resolve(hexParts.join(''));
                    }
                };

                reader.onerror = reject;
                const chunk = file.slice(offset, offset + chunkSize);
                reader.readAsArrayBuffer(chunk);
            };

            readChunk(0);
        });


        // handle file upload
        const uploadBtn = document.getElementById('upload-btn');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        function download() {
            const link = document.createElement("a");
            link.href = canvas.toDataURL("image/png");
            link.download = "FileArtImage_" +  Math.round(Math.random() * 100000) + ".png";
            link.click();
        }

        uploadBtn.addEventListener('change', handleUpload, false);

    function handleUpload(e) {
        const file = e.target.files[0];

        // convert file to hex
        fileToHex(file).then((hexData) => {
            // split hex string into 6 characters and convert to rgb
            const colors = hexData.match(/.{1,6}/g).map((hexPair) => {
                return {
                    r: parseInt(hexPair.substring(0, 2), 16),
                    g: parseInt(hexPair.substring(2, 4), 16),
                    b: parseInt(hexPair.substring(4, 6), 16),
                };
            });

            // determine canvas size based on file size
            const rowCount = Math.ceil(Math.sqrt(colors.length));
            const cellSize = 1; // size of each cell in pixels
            let canvasWidth = cvWidth || (cellSize * rowCount);
            let canvasHeight = cellSize * rowCount;

            // make sure canvas can fit all the data
            while (colors.length > canvasWidth * canvasHeight) {
                // expand canvas if needed
                //canvasWidth++;
                canvasHeight++;
            }

            // create canvas and context
            const canvas = document.getElementById("canvas");
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;
            const ctx = canvas.getContext("2d");

            // draw colors on canvas
            let x = 0;
            let y = 0;
            colors.forEach((color) => {
                ctx.fillStyle = `rgb(${color.r}, ${color.g}, ${color.b})`;
                ctx.fillRect(x, y, cellSize, cellSize);

                x += cellSize;
                if (x >= canvas.width) {
                    x = 0;
                    y += cellSize;
                }
            });
        });
    }
    </script>
    
</body>
</html>